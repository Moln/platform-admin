<div>
    <div id="admin-role-toolbar"></div>
    <br>

    <div id="admin-role-tree"></div>
</div>
<div class="admin-trees-index-tree-add-form pa-box">
    <form class="form">
        <ul>
            <li>
                <label>上级菜单:</label>
                <span class="parent-name"></span>
            </li>
            <li>
                <label for="role_name">角色名称:</label>
                <input type="text" class="k-textbox" name="role_name" autofocus="autofocus" required/>
            </li>
            <li>
                <input type="hidden" class="k-textbox" name="role_id"/>
            </li>
            <li>
                <input type="hidden" class="k-textbox" name="parent_id"/>
            </li>
            <li class="form-row">
                <button class="k-button" id="add_submit"><span class="k-icon k-i-tick"></span>提 交</button>
                <button type="button" class="closeButton">返回</button>
            </li>
        </ul>
    </form>
</div>

<div class="admin-trees-index-tree-edit-form pa-box">
    <form class="form">
        <ul>
            <li>
                <label for="role_name">角色名称:</label>
                <input type="text" class="k-textbox" name="role_name" autofocus="autofocus" required/>
            </li>
            <li>
                <input type="hidden" class="k-textbox" name="role_id"/>
            </li>
            <li>
                <input type="hidden" class="k-textbox" name="parent_id"/>
            </li>
            <li class="form-row">
                <button class="k-button" id="edit_submit"><span class="k-icon k-i-tick"></span>提 交
                </button>
                <button type="button" class="closeButton">返回</button>
            </li>
        </ul>
    </form>
</div>
<style>
    #admin-trees-index-tree {
        float: left;
    }

    .admin-trees-index-tree-add-form,
    .admin-trees-index-tree-edit-form {
        padding: 2em;
        width: 460px;
        display: none;
    }

    .admin-trees-index-tree-add:hover,
    .admin-trees-index-tree-delete:hover {
        opacity: 0.5;
    }
</style>

<script>
    $(function () {
        var $toolbar = $("#admin-role-toolbar").kendoToolBar({
            items: [
                {
                    type: "button",
                    id: "role-assign-permission",
                    text: "分配角色权限",
                    enable: false,
                    click: function () {
                        var item = kTreeView.dataItem(kTreeView.select());
                        $('<div>').appendTo('body').kendoWindow({
                            width: "80%",
                            height: '90%',
                            title: '用户角色分配',
                            content: "./admin/role/assign-permission/id/" + item.role_id,
                            close: function () {
                                this.destroy();
                            },
                            modal: true
                        }).data('kendoWindow').center();
                    }
                },
                {
                    type: "button",
                    id: "role-assign-user",
                    text: "用户角色分配",
                    enable: false,
                    click: function () {
                        var item = kTreeView.dataItem(kTreeView.select());
                        $('<div>').appendTo('body').kendoWindow({
                            width: "80%",
                            height: '90%',
                            title: '用户角色分配',
                            content: "./admin/role/assign-user/id/" + item.role_id,
                            close: function () {
                                this.destroy();
                            },
                            modal: true
                        }).data('kendoWindow').center();
                    }
                }
            ]
        }), $tree, kTreeView;
        $.get('./admin/role/read', function (data) {
            $tree = $("#admin-role-tree").kendoTreeView({
                    dragAndDrop: true,
                    dataSource: data.roles,
                    template: kendo.template($("#admin-trees-index-tree-template").html()),
                    select: function (e) {
                        $toolbar.data("kendoToolBar").enable('#role-assign-permission');
                        $toolbar.data("kendoToolBar").enable('#role-assign-user');
                        var dataItem = kTreeView.dataItem(e.node);
                    },
                    drop: function (e) {
                        if (e.dropPosition != 'over') {
                            e.setValid(false);
                        }
                        if (!e.destinationNode || !e.valid) {
                            e.setValid(false);
                            return;
                        }

                        var sourceNode = kTreeView.dataItem(e.sourceNode),
                            destinationNode = kTreeView.dataItem(e.destinationNode);

                        var $targetNode = $(e.destinationNode), allow = false;
                        $targetNode.parents('.k-item').andSelf().each(function () {
                            var parentItem = kTreeView.dataItem(this);
                            if ($.inArray(parseInt(parentItem.role_id), data.access_roles) > -1) {
                                allow = true;
                            }
                        });
                        e.setValid(allow);
                    },
                    dragend: function (e) {
                        var sourceNode = kTreeView.dataItem(e.sourceNode),
                            destinationNode = kTreeView.dataItem(e.destinationNode),
                            data = {"role_id": sourceNode.role_id, "name": sourceNode.text, "parent": destinationNode.role_id};

                        if (e.dropPosition == 'over') {
                            $.post('./admin/role/update', data, function (e) {
                                sourceNode.set('parent_id', destinationNode.role_id);
                            });
                        }
                    }
                });
            kTreeView = $tree.data('kendoTreeView');

            kTreeView.select($()); // clears selection
            kTreeView.expand(".k-item");


            //节点添加
            $tree.on("click", ".admin-role-add", function (e) {
                e.preventDefault();

                var $item = $(this).closest(".k-item"),
                    dataItem = kTreeView.dataItem($item),
                    roleName = prompt("请输入角色名");

                if (roleName) {
                    $.post('./admin/role/add', {'name': roleName, parent: dataItem.role_id}, function (result) {
                        kTreeView.append({
                            "text": result.name,
                            "role_id": result.role_id,
                            "parent_id": dataItem.role_id
                        }, $item);
                    });
                }
            });

            //节点删除
            $tree.on("click", ".admin-role-delete", function (e) {
                e.preventDefault();

                if (confirm('确认删除?')) {

                    var node = $(this).closest(".k-item"),
                        dataItem = kTreeView.dataItem(node),
                        nodes = node.find('.k-item').andSelf(),
                        data = [];

                    nodes.each(function () {
                        var nodeData = kTreeView.dataItem(this);
                        data.push(nodeData.role_id);

                    });

                    $.post('./admin/role/delete', {'roles': data}, function () {
                        kTreeView.remove(node);
                    });
                }
            });

            //节点名称编辑
            $tree.on("dblclick", "span.k-in", function (e) {
                e.preventDefault();

                var $item = $(this).closest(".k-item"),
                    dataItem = kTreeView.dataItem($item),
                    roleName = prompt("请输入角色名", dataItem.text);

                if (roleName) {
                    $.post(
                        './admin/role/update',
                        {'name': roleName, role_id: dataItem.role_id, parent: dataItem.parent_id},
                        function (result) {
                            $item.find('span.k-text').html(roleName);
                        }
                    );
                }

                return false;
            });

        });
    });

</script>

<script id="admin-trees-index-tree-template" type="text/kendo-ui-template">
    <span class="k-text">#: item.text #</span>
    <span class="admin-role-add k-icon k-i-plus"></span>
    <span class="admin-role-delete k-icon k-i-close"></span>
</script>